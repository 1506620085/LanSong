# IP用户识别功能测试指南

## 测试前准备

1. 确保已安装依赖
```bash
# 安装后端依赖
cd server
npm install

# 安装前端依赖
cd ../client
npm install
```

2. 启动服务

**开发模式：**
```bash
# 终端1 - 启动后端
cd server
npm start

# 终端2 - 启动前端
cd client
npm run dev
```

**或使用快捷脚本（Windows）：**
```bash
start-dev.bat
```

## 测试场景

### 场景1：首次访问 - 未设置用户名

**测试步骤：**
1. 打开浏览器访问 `http://localhost:3000`
2. 观察顶部用户信息卡片

**预期结果：**
- ✅ 显示本机IP地址
- ✅ 用户名显示"未设置"（红色斜体）
- ✅ 按钮显示"设置用户名"

### 场景2：设置用户名

**测试步骤：**
1. 点击"设置用户名"按钮
2. 在弹出的对话框中输入用户名，例如："测试用户1"
3. 点击"确定"按钮

**预期结果：**
- ✅ 提示"用户名设置成功"
- ✅ 对话框关闭
- ✅ 用户信息卡片显示设置的用户名（蓝色加粗）
- ✅ 按钮文字变为"修改用户名"

### 场景3：用户名验证测试

**测试步骤A - 空用户名：**
1. 点击"修改用户名"
2. 清空输入框
3. 点击"确定"

**预期结果：**
- ✅ 提示"请输入用户名"
- ✅ 对话框不关闭

**测试步骤B - 超长用户名：**
1. 输入超过20个字符的用户名
2. 观察输入框

**预期结果：**
- ✅ 输入框限制为20个字符
- ✅ 显示字符计数

**测试步骤C - 重复用户名：**
1. 使用另一台设备或清除浏览器数据模拟新IP
2. 设置与第一个用户相同的用户名

**预期结果：**
- ✅ 提示"该用户名已被使用"

### 场景4：未设置用户名时点歌

**测试步骤：**
1. 清除浏览器数据或使用无痕模式访问
2. 搜索歌曲，例如："周杰伦"
3. 点击任意歌曲的"点歌"按钮

**预期结果：**
- ✅ 提示"请先设置用户名后再点歌"
- ✅ 自动弹出用户名设置对话框
- ✅ 歌曲未添加到队列

### 场景5：设置用户名后点歌

**测试步骤：**
1. 设置用户名
2. 搜索歌曲
3. 点击"点歌"按钮

**预期结果：**
- ✅ 提示"已添加「歌曲名」到播放队列"
- ✅ 歌曲出现在播放队列中
- ✅ 队列中显示歌曲信息和点歌用户名（带用户图标）

### 场景6：队列中显示点歌用户

**测试步骤：**
1. 多个不同IP（或浏览器）设置不同用户名
2. 每个用户点不同的歌
3. 查看播放队列

**预期结果：**
- ✅ 每首歌下方显示点歌用户名
- ✅ 用户名颜色为蓝色（#667eea）
- ✅ 用户名前有用户图标

### 场景7：修改用户名

**测试步骤：**
1. 点击"修改用户名"按钮
2. 输入新的用户名，例如："新用户名"
3. 点击"确定"

**预期结果：**
- ✅ 提示"用户名设置成功"
- ✅ 用户信息卡片更新为新用户名
- ✅ 新点的歌显示新用户名
- ✅ 之前点的歌仍显示旧用户名

### 场景8：多用户同时点歌

**测试步骤：**
1. 在局域网内使用3台不同设备
2. 每台设备设置不同用户名
3. 每个用户点2-3首歌
4. 在主控播放器查看队列

**预期结果：**
- ✅ 所有歌曲按点歌顺序排列
- ✅ 每首歌显示对应的点歌用户
- ✅ 所有设备实时同步队列状态

### 场景9：服务器重启后数据持久化

**测试步骤：**
1. 设置用户名并点几首歌
2. 重启服务器（Ctrl+C 然后重新 npm start）
3. 刷新浏览器页面

**预期结果：**
- ✅ 用户名保持不变
- ✅ IP与用户名的对应关系保持
- ✅ 无需重新设置用户名

### 场景10：API接口测试

**使用Postman或curl测试：**

```bash
# 1. 获取用户信息
curl http://localhost:3000/api/user/info

# 预期响应：
{
  "success": true,
  "data": {
    "ip": "127.0.0.1",
    "username": "测试用户",
    "hasUsername": true
  }
}

# 2. 设置用户名
curl -X POST http://localhost:3000/api/user/setname \
  -H "Content-Type: application/json" \
  -d '{"username":"测试用户2"}'

# 预期响应：
{
  "success": true,
  "data": {
    "username": "测试用户2",
    "ip": "127.0.0.1",
    "lastUpdated": "2024-01-01T00:00:00.000Z"
  }
}

# 3. 获取所有用户
curl http://localhost:3000/api/user/all

# 预期响应：
{
  "success": true,
  "data": {
    "127.0.0.1": {
      "username": "测试用户2",
      "ip": "127.0.0.1",
      "lastUpdated": "2024-01-01T00:00:00.000Z"
    }
  }
}
```

## 测试检查清单

- [ ] 用户信息卡片正常显示
- [ ] IP地址显示正确
- [ ] 用户名设置功能正常
- [ ] 用户名验证规则生效
- [ ] 未设置用户名无法点歌
- [ ] 点歌后队列显示用户名
- [ ] 用户名修改功能正常
- [ ] 多用户点歌互不干扰
- [ ] 数据持久化正常
- [ ] API接口响应正确

## 常见问题排查

### 问题1：IP地址显示为 "unknown" 或 "::1"

**原因：** 本地访问可能显示为IPv6地址

**解决：**
- 使用 `http://127.0.0.1:3000` 代替 `http://localhost:3000`
- 或使用局域网IP访问

### 问题2：用户名设置后刷新页面丢失

**原因：** 后端服务未正常启动或文件权限问题

**解决：**
- 检查 `server/ip-users.json` 文件是否存在
- 检查服务器控制台是否有错误信息
- 重启服务器

### 问题3：提示"该用户名已被使用"但没有其他用户

**原因：** IP地址变化导致

**解决：**
- 查看 `server/ip-users.json` 文件内容
- 删除旧的IP记录或使用不同的用户名

### 问题4：点歌时没有弹出用户名设置对话框

**原因：** 前端代码缓存或状态异常

**解决：**
- 清除浏览器缓存
- 硬刷新页面（Ctrl+Shift+R）
- 检查浏览器控制台错误

## 性能测试

### 并发测试
- 同时10个用户设置用户名
- 同时20个用户点歌
- 观察服务器响应时间

### 数据量测试
- 模拟100个不同IP的用户
- 每个用户点10首歌
- 检查队列显示性能

## 测试完成

如果以上测试场景全部通过，说明IP用户识别功能已正常工作！

如有问题，请查看：
- 服务器控制台日志
- 浏览器开发者工具控制台
- `server/ip-users.json` 文件内容
