# IP用户识别功能说明

## 功能概述

新增了基于IP地址的用户识别功能，局域网用户需要设置用户名后才能点歌。

## 主要功能

### 1. 用户信息显示
- 在点歌页面顶部显示本机局域网IP地址
- 显示当前用户设置的用户名
- 提供"设置用户名"或"修改用户名"按钮

### 2. 用户名设置
- 用户名长度限制：1-20个字符
- 用户名唯一性：同一用户名不能被多个IP使用
- 用户名与IP地址一一对应

### 3. 点歌权限控制
- 未设置用户名的用户无法点歌
- 点歌时自动弹出用户名设置对话框
- 点歌后在队列中显示点歌用户

### 4. 队列信息增强
- 每首歌曲显示点歌用户名
- 点歌用户信息与歌曲一起保存

## 技术实现

### 后端
1. **ip-manager.js** - IP用户管理模块
   - 管理IP与用户名的映射关系
   - 提供用户名设置、查询、验证功能
   - 数据持久化到 `ip-users.json` 文件

2. **app.js** - API接口
   - `GET /api/user/info` - 获取当前IP的用户信息
   - `POST /api/user/setname` - 设置当前IP的用户名
   - `GET /api/user/all` - 获取所有用户（管理用）
   - 修改 `/api/queue/add` 接口，添加用户验证

3. **数据存储**
   - 文件位置：`server/ip-users.json`
   - 存储格式：
   ```json
   {
     "192.168.1.100": {
       "username": "张三",
       "ip": "192.168.1.100",
       "lastUpdated": "2024-01-01T00:00:00.000Z"
     }
   }
   ```

### 前端
1. **api.js** - API调用封装
   - `getUserInfo()` - 获取用户信息
   - `setUsername(username)` - 设置用户名
   - `getAllUsers()` - 获取所有用户

2. **Request.vue** - 点歌页面
   - 用户信息卡片显示
   - 用户名设置对话框
   - 点歌前用户验证
   - 队列中显示点歌用户

## 使用说明

### 首次使用
1. 访问点歌页面
2. 在顶部看到本机IP地址和"未设置"的用户名
3. 点击"设置用户名"按钮
4. 输入用户名（1-20个字符）
5. 设置成功后即可正常点歌

### 修改用户名
1. 点击"修改用户名"按钮
2. 输入新的用户名
3. 保存即可

### 点歌流程
1. 确保已设置用户名
2. 搜索歌曲
3. 点击"点歌"按钮
4. 歌曲添加到队列，并显示点歌用户名

## 注意事项

1. **IP地址识别**
   - 系统自动识别客户端IP地址
   - 支持代理服务器环境（X-Forwarded-For）
   - IPv6环境会自动转换为IPv4格式

2. **用户名限制**
   - 不能为空
   - 长度1-20个字符
   - 不能与其他IP的用户名重复

3. **数据持久化**
   - 用户名信息保存在服务器端
   - 重启服务器后数据不会丢失
   - IP变化后需要重新设置用户名

4. **多用户环境**
   - 每个IP地址对应一个用户名
   - 适用于局域网多人点歌场景
   - 可追踪每首歌的点歌用户

## 文件清单

### 新增文件
- `server/ip-manager.js` - IP用户管理模块
- `server/ip-users.json` - IP用户数据存储（自动创建）
- `IP_USER_FEATURE.md` - 功能说明文档（本文件）

### 修改文件
- `server/app.js` - 添加IP用户管理API接口
- `client/src/utils/api.js` - 添加用户管理API调用
- `client/src/views/Request.vue` - 添加用户信息显示和设置功能

## 后续优化建议

1. 添加用户管理页面，可以查看所有用户和点歌统计
2. 添加用户黑名单功能
3. 添加点歌次数限制
4. 添加用户积分或等级系统
5. 支持用户头像设置
