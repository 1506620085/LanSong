# 管理密码功能说明

## 功能概述

为了提供更灵活的管理权限控制，系统新增了管理密码功能。现在除了部署服务的主机外，其他用户也可以通过输入正确的管理密码来访问管理设置页面。

## 权限分级

### 1. 主机用户（服务器本机）
- **识别方式**：基于IP地址自动识别
- **权限**：完全管理权限，无需密码
- **标识**：管理页面显示红色"主机"标签
- **限制**：无任何操作限制

### 2. 管理员用户（通过密码验证）
- **识别方式**：输入正确的管理密码后获得临时会话
- **权限**：完全管理权限（与主机用户相同）
- **标识**：管理页面显示橙色"管理员"标签
- **会话有效期**：24小时
- **限制**：无操作限制，但需要定期重新验证密码

### 3. 普通用户
- **权限**：只能访问点歌页面和播放器页面
- **限制**：受点歌、切歌、顶置限额控制

## 配置方法

### 1. 设置管理密码

编辑 `server/config.json` 文件，添加 `adminPassword` 字段：

```json
{
  "loginMethod": "qrcode",
  "port": 3000,
  "adminPassword": "your_secure_password"
}
```

**重要提示：**
- 建议使用强密码（包含字母、数字、符号）
- 不要使用过于简单的密码（如 "123456"）
- 定期更换管理密码
- 默认密码为 `admin123`（请务必修改）

### 2. 重启服务

修改配置后，需要重启后端服务才能生效：

```bash
# 停止服务（Ctrl+C）
# 重新启动
cd server
npm start
```

## 使用方法

### 主机用户访问管理页面
1. 在服务器本机浏览器访问：`http://localhost:3000/admin`
2. 系统自动识别为主机用户，直接进入管理页面
3. 显示红色"主机"标签，无任何限制

### 非主机用户访问管理页面
1. 在其他设备浏览器访问：`http://[服务器IP]:3000/admin`
2. 系统显示"管理员身份验证"界面
3. 输入配置的管理密码
4. 验证成功后进入管理页面
5. 显示橙色"管理员"标签
6. 可点击"退出管理"按钮退出管理会话

## 技术实现

### 后端实现
- **会话管理**：使用内存存储管理员会话（Map数据结构）
- **Token生成**：使用 `crypto.randomBytes(32)` 生成随机token
- **会话有效期**：24小时自动过期
- **自动清理**：每小时自动清理过期会话
- **API认证**：所有管理API都需要验证主机身份或有效token

### 前端实现
- **Token存储**：使用 `localStorage` 保存管理token
- **自动携带**：所有管理API请求自动携带token（`x-admin-token` header）
- **会话管理**：支持退出管理会话，清除本地token
- **界面适配**：根据用户身份显示不同标识和功能

### API接口

#### 1. 验证管理密码
```
POST /api/admin/verify-password
Body: { "password": "your_password" }
Response: { "success": true, "token": "generated_token" }
```

#### 2. 检查管理权限
```
GET /api/admin/check
Headers: { "x-admin-token": "token" }
Response: {
  "success": true,
  "isHost": false,
  "hasAdminAccess": true,
  "serverIP": "192.168.1.100",
  "clientIP": "192.168.1.101"
}
```

#### 3. 退出管理会话
```
POST /api/admin/logout-session
Headers: { "x-admin-token": "token" }
Response: { "success": true, "message": "已退出管理会话" }
```

## 安全建议

### 1. 密码安全
- ✅ 使用强密码（至少12位，包含大小写字母、数字、符号）
- ✅ 定期更换管理密码
- ✅ 不要在公共场合输入密码
- ✅ 不要将密码分享给他人
- ❌ 不要使用弱密码（如 "123456", "password"）
- ❌ 不要使用与其他账号相同的密码

### 2. 会话安全
- 管理会话有效期为24小时
- 离开时建议点击"退出管理"
- 在公共设备上使用后务必退出
- 浏览器会自动保存token，注意清理

### 3. 网络安全
- 建议在安全的局域网环境内使用
- 避免在公共WiFi下访问管理页面
- 如需在互联网访问，建议配置HTTPS
- 定期检查访问日志

## 故障排查

### 问题：输入密码后提示"密码错误"
- 检查配置文件中的 `adminPassword` 是否正确
- 注意密码区分大小写
- 确认配置文件格式正确（JSON格式）
- 确认修改配置后已重启服务

### 问题：验证成功后仍无法访问
- 检查浏览器是否阻止了localStorage
- 清除浏览器缓存后重试
- 检查网络连接是否正常
- 查看浏览器控制台是否有错误信息

### 问题：会话突然失效
- 检查是否超过24小时有效期
- 检查服务器是否重启（重启会清空所有会话）
- 重新输入密码验证即可

### 问题：主机用户也要求输入密码
- 检查服务器IP识别是否正确
- 可能是通过代理或NAT访问
- 尝试使用 `localhost` 或 `127.0.0.1` 访问
- 检查后端日志中显示的"服务器主机IP"

## 版本信息

- **功能版本**：v1.1.0
- **更新日期**：2025-11-18
- **兼容性**：向后兼容，不影响现有功能

## 相关文档

- [README.md](README.md) - 项目总体说明
- [GUIDE.md](GUIDE.md) - 详细使用指南
- [FAQ.md](FAQ.md) - 常见问题解答
- [PROJECT_STRUCTURE.md](PROJECT_STRUCTURE.md) - 项目结构说明
